---
title: "optmization_2022"
author: "Marcus Antonio Cardoso Ramalho"
date: "2022-10-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}
library(tidyquant) # To download the data
library(plotly) # To create interactive charts
library(timetk) # To manipulate the data series
library(plotly)
library(tidyverse)
```

```{r}


portfolio <- read_delim("dados/carteira_final.txt")
(tick<-portfolio$Ticker)

Rfr<-0.13

price_data <- tq_get(tick,
                     from = '2017-01-02',
                     to = '2019-12-31',
                     get = 'stock.prices')

#Next we will calculate the daily returns for 
#these stocks. We will use the logarithmic returns.

log_ret_tidy <- price_data %>%
  group_by(symbol) %>%
  tq_transmute(select = adjusted,
               mutate_fun = periodReturn,
               period = 'daily',
               col_rename = 'ret',
               type = 'log')

head(log_ret_tidy)
```

```{r}

# As you can see that this data is in tidy format. 
#We will use the spread() function to convert it to a wide format. 
#And we will also convert it into a time series object using xts() function.
log_ret_xts <- log_ret_tidy %>%
  spread(symbol, value = ret) %>%
  tk_xts()

head(log_ret_xts)

```


```{r}
#Next lets calculate the mean daily returns for each asset.
mean_ret <- colMeans(log_ret_xts)
print(round(mean_ret, 5))

#Next we will calculate the covariance matrix for all these stocks.
#We will annualize it by multiplying by 252.

cov_mat <- cov(log_ret_xts) * 252
round(cov_mat,4)

num_port <- 5000

# Creating a matrix to store the weights

all_wts <- matrix(nrow = num_port,
                  ncol = length(tick))

# Creating an empty vector to store
# Portfolio returns

port_returns <- vector('numeric', length = num_port)

# Creating an empty vector to store
# Portfolio Standard deviation

port_risk <- vector('numeric', length = num_port)

# Creating an empty vector to store
# Portfolio Sharpe Ratio

sharpe_ratio <- vector('numeric', length = num_port)

```

```{r}

#Next lets run the for loop 5000 times.

for (i in seq_along(port_returns)) {
  
  wts <- runif(length(tick))
  wts <- wts/sum(wts)
  
  # Storing weight in the matrix
  all_wts[i,] <- wts
  
  # Portfolio returns
  
  port_ret <- sum(wts * mean_ret)
  port_ret <- ((port_ret + 1)^252) - 1
  
  # Storing Portfolio Returns values
  port_returns[i] <- port_ret
  
  
  # Creating and storing portfolio risk
  port_sd <- sqrt(t(wts) %*% (cov_mat  %*% wts))
  port_risk[i] <- port_sd
  
  # Creating and storing Portfolio Sharpe Ratios
  # Assuming 0% Risk free rate
  
  sr <- (port_ret-Rfr)/port_sd
  sharpe_ratio[i] <- sr
  
}

```

```{r}

# Storing the values in the table
portfolio_values <- tibble(Return = port_returns,
                           Risk = port_risk,
                           SharpeRatio = sharpe_ratio)


# Converting matrix to a tibble and changing column names
all_wts <- tk_tbl(all_wts)

colnames(all_wts) <- colnames(log_ret_xts)

# Combing all the values together
portfolio_values <- tk_tbl(cbind(all_wts, portfolio_values))

#The minimum variance portfolio
#The tangency portfolio (the portfolio with highest sharpe ratio)

min_var <- portfolio_values[which.min(portfolio_values$Risk),]
max_sr <- portfolio_values[which.max(portfolio_values$SharpeRatio),]



#Lets plot the weights of each portfolio. First with the minimum variance portfolio.

p <- min_var %>%
  gather(ABCP11.SA:XPCM11.SA, key = Asset,
         value = Weights) %>%
  mutate(Asset = as.factor(Asset)) %>%
  ggplot(aes(x = fct_reorder(Asset,Weights), y = Weights, fill = Asset)) +
  geom_bar(stat = 'identity') +
  theme_minimal() +
  labs(x = 'Assets', y = 'Weights', title = "Minimum Variance Portfolio Weights") +
  scale_y_continuous(labels = scales::percent) 

ggplotly(p)

#Next lets look at the tangency portfolio or the the portfolio with the highest sharpe ratio.

p <- max_sr %>%
  gather(ABCP11.SA:XPCM11.SA, key = Asset,
         value = Weights) %>%
  mutate(Asset = as.factor(Asset)) %>%
  ggplot(aes(x = fct_reorder(Asset,Weights), y = Weights, fill = Asset)) +
  geom_bar(stat = 'identity') +
  theme_minimal() +
  labs(x = 'Assets', y = 'Weights', title = "Tangency Portfolio Weights") +
  scale_y_continuous(labels = scales::percent) 

ggplotly(p)

p <- portfolio_values %>%
  ggplot(aes(x = Risk, y = Return, color = SharpeRatio)) +
  geom_point() +
  theme_classic() +
  scale_y_continuous(labels = scales::percent) +
  scale_x_continuous(labels = scales::percent) +
  labs(x = 'Annualized Risk',
       y = 'Annualized Returns',
       title = "Portfolio Optimization & Efficient Frontier") +
  geom_point(aes(x = Risk,
                 y = Return), data = min_var, color = 'red') +
  geom_point(aes(x = Risk,
                 y = Return), data = max_sr, color = 'red') 
  
  
  #annotate('text', x = 0.20, y = 0.42, label = "Tangency Portfolio") +
 # annotate('text', x = 0.18, y = 0.01, label = "Minimum variance portfolio") +
 # annotate(geom = 'segment', x = 0.14, xend = 0.135,  y = 0.01, 
        #   yend = 0.06, color = 'red', arrow = arrow(type = "open")) +
  #annotate(geom = 'segment', x = 0.22, xend = 0.2275,  y = 0.405, 
         #  yend = 0.365, color = 'red', arrow = arrow(type = "open"))


ggplotly(p)









```



```{r}

(min_var_2p)
(max_sr_2p)

(min_var)
(max_sr)

comparativo<-rbind(min_var_2p,min_var,max_sr_2p,max_sr) #variancia min (2%) etc...

comparativo<-comparativo %>% 
  rowid_to_column("port_number")#adicionando o numero de cada portifolio 

table_risk_return_sharpe_by_port<-comparativo %>% 
  select(port_number,Return,Risk,SharpeRatio)

table_comp_Ticker<-comparativo%>% 
pivot_longer(cols = ABCP11.SA:XPCM11.SA, #Alongando a tabela para receber as categorias
             names_to = "Ticker",
             values_to = "weight")  
  
table_comp_Ticker<-table_comp_Ticker %>% 
  inner_join(portfolio,comparativo,by="Ticker")  #adiciona as categorias
  
  table_comp_Ticker$Categoria<- as_factor(table_comp_Ticker$Categoria)
  
  
  view(table_comp_Ticker)
  
##
  

table_comp_Sector2<-table_comp_Ticker %>% 
  select(port_number,Ticker,Categoria,weight,everything()) %>%#Soma dos pesos por categoria !!funcionando
  group_by(Categoria, port_number) %>% 
  summarise(count=n(),sum_weights=sum(weight))

  table_comp_Sector2<-table_comp_Sector2 %>% 
    arrange(port_number)

  view(table_comp_Sector2)
  
  #table_comp_Sector_complete<-inner_join(table_comp_Sector2,table_risk_return_sharpe_by_port,by="port_number")
  
  #table_comp_Sector_complete<-table_comp_Sector_complete %>% 
    #arrange(port_number)
  
  
  #view(table_comp_Sector_complete)
    
  
  
  
  
  
 
  

  
  
  
  #table_comp_Sector<-table_comp_Ticker %>% 
  #select(port_number,Ticker,Categoria,weight,everything()) %>%#Soma dos pesos por categoria
  #group_by(port_number) %>%
  #group_by(Categoria) %>% 
  #summarise(sum_weights=sum(weight),port_number=port_number,Return=Return,Risk=Risk,SharpeRatio=SharpeRatio)


#view(table_comp_Sector)

```

```{r}
table_comp_Sector<-table_comp_Sector %>% 
  arrange(port_number)

```

